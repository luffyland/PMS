<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM Tracker ‚Äî Preventive Maintenance System</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #21262d;
    --border: #30363d;
    --accent: #00d4aa;
    --accent2: #f7931e;
    --accent3: #4f8ef7;
    --text: #e6edf3;
    --text2: #8b949e;
    --text3: #484f58;
    --danger: #f85149;
    --success: #3fb950;
    --warning: #d29922;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; }

  /* LAYOUT */
  .app { display: flex; min-height: 100vh; }
  .sidebar {
    width: 240px; min-width: 240px; background: var(--surface);
    border-right: 1px solid var(--border); display: flex; flex-direction: column;
    position: fixed; height: 100vh; z-index: 100;
  }
  .main { margin-left: 240px; flex: 1; padding: 28px 32px; }

  /* SIDEBAR */
  .sidebar-logo {
    padding: 20px 20px 16px;
    border-bottom: 1px solid var(--border);
  }
  .logo-tag { font-family: var(--mono); font-size: 10px; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
  .logo-title { font-size: 16px; font-weight: 700; color: var(--text); line-height: 1.2; }

  .gs-status {
    margin: 12px 14px 0;
    padding: 8px 12px;
    background: var(--surface2);
    border-radius: 6px;
    border: 1px solid var(--border);
    font-size: 11px;
  }
  .gs-status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .gs-status-dot.connected { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .gs-status-dot.disconnected { background: var(--text3); }
  .gs-status-label { color: var(--text2); }

  .nav { flex: 1; padding: 16px 10px; overflow-y: auto; }
  .nav-section { margin-bottom: 20px; }
  .nav-section-label { font-size: 10px; color: var(--text3); letter-spacing: 1.5px; text-transform: uppercase; font-weight: 600; padding: 0 10px; margin-bottom: 6px; font-family: var(--mono); }
  .nav-item {
    display: flex; align-items: center; gap: 10px; padding: 8px 10px;
    border-radius: 6px; cursor: pointer; transition: all 0.15s; font-size: 13.5px;
    color: var(--text2); margin-bottom: 2px; border: 1px solid transparent;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: rgba(0,212,170,0.1); color: var(--accent); border-color: rgba(0,212,170,0.2); }
  .nav-icon { width: 16px; text-align: center; }

  .sidebar-footer { padding: 14px; border-top: 1px solid var(--border); }
  .gs-connect-btn {
    width: 100%; padding: 9px; background: rgba(0,212,170,0.1);
    border: 1px solid rgba(0,212,170,0.3); border-radius: 6px;
    color: var(--accent); font-size: 12px; font-family: var(--sans);
    cursor: pointer; transition: all 0.2s; font-weight: 500;
  }
  .gs-connect-btn:hover { background: rgba(0,212,170,0.2); }

  /* PAGE */
  .page { display: none; }
  .page.active { display: block; }

  .page-header { margin-bottom: 24px; }
  .page-title { font-size: 22px; font-weight: 700; color: var(--text); }
  .page-sub { font-size: 13px; color: var(--text2); margin-top: 4px; }
  .page-actions { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }

  /* BUTTONS */
  .btn {
    padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500;
    cursor: pointer; border: 1px solid transparent; transition: all 0.15s;
    font-family: var(--sans); display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: var(--accent); color: #0d1117; border-color: var(--accent); }
  .btn-primary:hover { background: #00e6ba; }
  .btn-secondary { background: var(--surface2); color: var(--text); border-color: var(--border); }
  .btn-secondary:hover { border-color: var(--text2); }
  .btn-danger { background: rgba(248,81,73,0.1); color: var(--danger); border-color: rgba(248,81,73,0.3); }
  .btn-danger:hover { background: rgba(248,81,73,0.2); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 24px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 16px; position: relative; overflow: hidden;
  }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
  .stat-card.c1::before { background: var(--accent); }
  .stat-card.c2::before { background: var(--accent3); }
  .stat-card.c3::before { background: var(--accent2); }
  .stat-card.c4::before { background: var(--danger); }
  .stat-value { font-size: 28px; font-weight: 700; font-family: var(--mono); color: var(--text); }
  .stat-label { font-size: 12px; color: var(--text2); margin-top: 4px; }
  .stat-icon { position: absolute; right: 16px; top: 16px; font-size: 22px; opacity: 0.4; }

  /* CARDS */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
  .card-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .card-title { font-size: 14px; font-weight: 600; color: var(--text); }
  .card-body { padding: 18px; }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead { background: var(--surface2); }
  th { padding: 10px 14px; text-align: left; font-weight: 600; font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 11px 14px; border-bottom: 1px solid rgba(48,54,61,0.5); color: var(--text); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }

  /* BADGES */
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 500; }
  .badge-green { background: rgba(63,185,80,0.15); color: var(--success); border: 1px solid rgba(63,185,80,0.2); }
  .badge-orange { background: rgba(210,153,34,0.15); color: var(--warning); border: 1px solid rgba(210,153,34,0.2); }
  .badge-red { background: rgba(248,81,73,0.15); color: var(--danger); border: 1px solid rgba(248,81,73,0.2); }
  .badge-blue { background: rgba(79,142,247,0.15); color: var(--accent3); border: 1px solid rgba(79,142,247,0.2); }
  .badge-gray { background: rgba(139,148,158,0.1); color: var(--text2); border: 1px solid var(--border); }

  /* FORMS */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.span2 { grid-column: span 2; }
  label { font-size: 12px; font-weight: 500; color: var(--text2); }
  input, select, textarea {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
    padding: 9px 12px; color: var(--text); font-size: 13px; font-family: var(--sans);
    transition: border-color 0.15s; width: 100%;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
  textarea { resize: vertical; min-height: 80px; }
  select option { background: var(--surface2); }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
    display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    width: 100%; max-width: 680px; max-height: 90vh; overflow-y: auto;
  }
  .modal-header { padding: 18px 22px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .modal-title { font-size: 16px; font-weight: 600; }
  .modal-close { background: none; border: none; color: var(--text2); font-size: 20px; cursor: pointer; padding: 0 4px; }
  .modal-close:hover { color: var(--text); }
  .modal-body { padding: 22px; }
  .modal-footer { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

  /* GS MODAL */
  .gs-modal-step { margin-bottom: 20px; }
  .gs-step-num { width: 24px; height: 24px; border-radius: 50%; background: var(--accent); color: #0d1117; font-weight: 700; font-size: 12px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; flex-shrink: 0; }
  .gs-step-row { display: flex; align-items: flex-start; margin-bottom: 12px; }
  .gs-step-content { flex: 1; }
  .gs-step-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
  .gs-step-desc { font-size: 12px; color: var(--text2); line-height: 1.6; }
  .code-block { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; font-family: var(--mono); font-size: 11.5px; color: var(--accent); margin-top: 8px; word-break: break-all; cursor: text; }
  
  /* TABS */
  .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .tab { padding: 9px 16px; font-size: 13px; cursor: pointer; color: var(--text2); border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s; }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab:hover { color: var(--text); }

  /* TOAST */
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px 16px; font-size: 13px; color: var(--text); min-width: 260px;
    animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px;
  }
  .toast.success { border-left: 3px solid var(--success); }
  .toast.error { border-left: 3px solid var(--danger); }
  .toast.info { border-left: 3px solid var(--accent3); }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* EMPTY */
  .empty-state { text-align: center; padding: 50px 20px; color: var(--text3); }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-text { font-size: 14px; }

  /* SCHEDULE CARD */
  .schedule-item {
    display: flex; align-items: center; gap: 14px; padding: 12px 0;
    border-bottom: 1px solid rgba(48,54,61,0.5);
  }
  .schedule-item:last-child { border-bottom: none; }
  .schedule-date { font-family: var(--mono); font-size: 11px; color: var(--text2); min-width: 80px; }
  .schedule-info { flex: 1; }
  .schedule-device { font-weight: 500; font-size: 13px; }
  .schedule-type { font-size: 12px; color: var(--text2); }
  .overdue-banner { background: rgba(248,81,73,0.08); border: 1px solid rgba(248,81,73,0.2); border-radius: 6px; padding: 10px 14px; margin-bottom: 16px; font-size: 13px; color: var(--danger); display: flex; align-items: center; gap: 8px; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .sidebar { width: 200px; min-width: 200px; }
    .main { margin-left: 200px; padding: 20px 16px; }
    .form-group.span2 { grid-column: span 1; }
  }
  @media (max-width: 600px) {
    .sidebar { display: none; }
    .main { margin-left: 0; }
  }

  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,212,170,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .sync-row { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text2); }
  .divider { height: 1px; background: var(--border); margin: 16px 0; }

  .checkbox-row { display: flex; flex-wrap: wrap; gap: 8px; }
  .checkbox-item { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; }
  .checkbox-item input { width: auto; }

  .filter-row { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .filter-row input, .filter-row select { max-width: 200px; }

  /* BUSINESS UNITS */
  .month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
  .month-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 14px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
  }
  .month-card:hover { border-color: var(--accent); }
  .month-card.current-month { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
  .month-card.has-bu { border-color: var(--accent3); }
  .month-card.current-month.has-bu { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
  .month-card-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; font-family: var(--mono); margin-bottom: 4px; }
  .month-card-name { font-size: 14px; font-weight: 600; color: var(--text); }
  .month-card-bu { font-size: 11px; color: var(--accent3); margin-top: 4px; }
  .month-card-badge { position: absolute; top: 10px; right: 10px; }
  .month-card.current-month .month-card-label { color: var(--accent); }
  .bu-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 16px; margin-bottom: 12px;
  }
  .bu-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .bu-card-name { font-size: 15px; font-weight: 600; }
  .bu-card-meta { font-size: 12px; color: var(--text2); display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 10px; }
  .bu-card-meta span { display: flex; align-items: center; gap: 4px; }
  .bu-devices { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .bu-device-tag { background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 3px 8px; font-size: 11px; color: var(--text2); }
  .month-pill { display: inline-flex; align-items: center; justify-content: center; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(79,142,247,0.15); color: var(--accent3); border: 1px solid rgba(79,142,247,0.2); }
  .month-pill.active-month { background: rgba(0,212,170,0.15); color: var(--accent); border-color: rgba(0,212,170,0.3); }
  .progress-bar-wrap { background: var(--surface2); border-radius: 4px; height: 6px; margin-top: 8px; }
  .progress-bar-fill { height: 100%; border-radius: 4px; background: var(--accent); transition: width 0.4s; }
</style>
</head>
<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-tag">PM System</div>
      <div class="logo-title">Preventive<br>Maintenance</div>
    </div>
    <div class="gs-status" id="gsStatusBar">
      <span class="gs-status-dot disconnected" id="gsDot"></span>
      <span class="gs-status-label" id="gsStatusText">Not connected</span>
    </div>
    <nav class="nav">
      <div class="nav-section">
        <div class="nav-section-label">Overview</div>
        <div class="nav-item active" onclick="navigate('dashboard')"><span class="nav-icon">‚äû</span> Dashboard</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-label">Maintenance</div>
        <div class="nav-item" onclick="navigate('log')"><span class="nav-icon">üìã</span> PM Logs</div>
        <div class="nav-item" onclick="navigate('bu')"><span class="nav-icon">üè¢</span> Business Units</div>
        <div class="nav-item" onclick="navigate('schedule')"><span class="nav-icon">üìÖ</span> Schedule</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-label">Assets</div>
        <div class="nav-item" onclick="navigate('users')"><span class="nav-icon">üë•</span> Users</div>
        <div class="nav-item" onclick="navigate('inventory')"><span class="nav-icon">üñ•Ô∏è</span> Inventory</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-label">Analytics</div>
        <div class="nav-item" onclick="navigate('reports')"><span class="nav-icon">üìä</span> Reports</div>
      </div>
    </nav>
    <div class="sidebar-footer">
      <button class="gs-connect-btn" onclick="openGSModal()">‚ö° Google Sheets Setup</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <div class="page-title">Dashboard</div>
        <div class="page-sub" id="dashDate"></div>
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openLogModal()">+ New PM Log</button>
          <button class="btn btn-secondary" onclick="syncToSheets()"><span id="syncIcon">‚Üë</span> Sync to Sheets</button>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-card c1"><div class="stat-icon">üñ•Ô∏è</div><div class="stat-value" id="statDevices">0</div><div class="stat-label">Total Devices</div></div>
        <div class="stat-card c2"><div class="stat-icon">üìã</div><div class="stat-value" id="statLogs">0</div><div class="stat-label">PM Logs This Month</div></div>
        <div class="stat-card c3"><div class="stat-icon">üìÖ</div><div class="stat-value" id="statDue">0</div><div class="stat-label">Due This Week</div></div>
        <div class="stat-card c4"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value" id="statOverdue">0</div><div class="stat-label">Overdue</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Recent PM Logs</div></div>
          <div class="card-body" id="recentLogs"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No logs yet</div></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Upcoming Schedule</div></div>
          <div class="card-body" id="upcomingSchedule"><div class="empty-state"><div class="empty-icon">üìÖ</div><div class="empty-text">No upcoming schedule</div></div></div>
        </div>
      </div>
    </div>

    <!-- PM LOGS -->
    <div id="page-log" class="page">
      <div class="page-header">
        <div class="page-title">PM Logs</div>
        <div class="page-sub">Complete maintenance activity records</div>
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openLogModal()">+ New PM Log</button>
          <button class="btn btn-secondary" onclick="exportCSV('logs')">‚Üì Export CSV</button>
        </div>
      </div>
      <div class="filter-row">
        <input type="text" id="logSearch" placeholder="Search device, technician..." oninput="renderLogs()">
        <select id="logFilterStatus" onchange="renderLogs()"><option value="">All Status</option><option>Completed</option><option>Pending</option><option>In Progress</option></select>
        <select id="logFilterType" onchange="renderLogs()"><option value="">All Types</option><option>Routine PM</option><option>Deep Clean</option><option>Hardware Check</option><option>Software Update</option><option>Full PM</option></select>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Date</th><th>Device</th><th>Type</th><th>Technician</th><th>Location</th><th>Status</th><th>Next PM</th><th>Actions</th></tr></thead>
            <tbody id="logTable"></tbody>
          </table>
          <div id="logEmpty" class="empty-state" style="display:none;"><div class="empty-icon">üìã</div><div class="empty-text">No logs found. Add your first PM log!</div></div>
        </div>
      </div>
    </div>

    <!-- BUSINESS UNITS -->
    <div id="page-bu" class="page">
      <div class="page-header">
        <div class="page-title">Business Units</div>
        <div class="page-sub">Each BU has a fixed PM month. Devices are grouped per BU.</div>
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openBUModal()">+ Add Business Unit</button>
          <button class="btn btn-secondary" onclick="syncToSheets()">‚Üë Sync to Sheets</button>
        </div>
      </div>

      <!-- Month calendar overview -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header"><div class="card-title">üìÜ Annual PM Calendar</div></div>
        <div class="card-body">
          <div class="month-grid" id="buMonthGrid"></div>
        </div>
      </div>

      <!-- BU list filtered by selected month -->
      <div class="card">
        <div class="card-header">
          <div class="card-title" id="buListTitle">All Business Units</div>
          <button class="btn btn-sm btn-secondary" id="buClearFilter" onclick="clearBUMonthFilter()" style="display:none;">‚úï Clear filter</button>
        </div>
        <div class="card-body" id="buList"></div>
      </div>
    </div>

    <!-- SCHEDULE -->
    <div id="page-schedule" class="page">
      <div class="page-header">
        <div class="page-title">Maintenance Schedule</div>
        <div class="page-sub">Generated from Business Unit monthly PM assignments</div>
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openScheduleModal()">+ Add Schedule</button>
        </div>
      </div>
      <div id="overdueBanner" class="overdue-banner" style="display:none;">‚ö†Ô∏è <span id="overdueCount"></span> device(s) have overdue maintenance!</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">üìÖ Upcoming (Next 30 days)</div></div>
          <div class="card-body" id="schedUpcoming"></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">‚ö†Ô∏è Overdue</div></div>
          <div class="card-body" id="schedOverdue"></div>
        </div>
      </div>
      <div class="card" style="margin-top:0">
        <div class="card-header"><div class="card-title">All Schedules</div></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Device</th><th>BU</th><th>Scheduled Date</th><th>Type</th><th>Assigned To</th><th>Status</th><th>Notes</th><th>Actions</th></tr></thead>
            <tbody id="schedTable"></tbody>
          </table>
          <div id="schedEmpty" class="empty-state" style="display:none;"><div class="empty-icon">üìÖ</div><div class="empty-text">No schedules yet</div></div>
        </div>
      </div>
    </div>

    <!-- USERS -->
    <div id="page-users" class="page">
      <div class="page-header">
        <div class="page-title">Users</div>
        <div class="page-sub">Registered requestors who submit PM requests</div>
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openUserModal()">+ Add User</button>
          <button class="btn btn-secondary" onclick="copyRegLink()">üîó Copy Registration Link</button>
          <button class="btn btn-secondary" onclick="exportCSV('users')">‚Üì Export CSV</button>
        </div>
      </div>

      <!-- Self-registration notice -->
      <div style="background:rgba(79,142,247,0.08);border:1px solid rgba(79,142,247,0.2);border-radius:8px;padding:14px 18px;margin-bottom:20px;display:flex;align-items:flex-start;gap:12px;">
        <span style="font-size:18px;">‚ÑπÔ∏è</span>
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--accent3);margin-bottom:4px;">Self-Registration Available</div>
          <div style="font-size:12px;color:var(--text2);">Users can register themselves by opening this file and clicking <strong style="color:var(--text);">Register as User</strong> on the login screen, or you can add them manually here. All registrations sync to Google Sheets.</div>
        </div>
      </div>

      <div class="filter-row">
        <input type="text" id="userSearch" placeholder="Search name, email, department..." oninput="renderUsers()">
        <select id="userFilterDept" onchange="renderUsers()"><option value="">All Departments</option></select>
        <select id="userFilterStatus" onchange="renderUsers()">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Full Name</th>
                <th>Department</th>
                <th>Email</th>
                <th>Registered</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userTable"></tbody>
          </table>
          <div id="userEmpty" class="empty-state" style="display:none;">
            <div class="empty-icon">üë•</div>
            <div class="empty-text">No users yet. Add one or share the registration link!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- INVENTORY -->
    <div id="page-inventory" class="page">
      <div class="page-header">
        <div class="page-title">Device Inventory</div>
        <div class="page-sub">Track all desktops and laptops</div>
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openDeviceModal()">+ Add Device</button>
          <button class="btn btn-secondary" onclick="exportCSV('devices')">‚Üì Export CSV</button>
        </div>
      </div>
      <div class="filter-row">
        <input type="text" id="devSearch" placeholder="Search device, serial..." oninput="renderDevices()">
        <select id="devFilterType" onchange="renderDevices()"><option value="">All Types</option><option>Desktop</option><option>Laptop</option></select>
        <select id="devFilterStatus" onchange="renderDevices()"><option value="">All Status</option><option>Active</option><option>Under Repair</option><option>Retired</option></select>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Device Name</th><th>Type</th><th>Brand/Model</th><th>Serial No.</th><th>Location</th><th>User</th><th>Status</th><th>Last PM</th><th>Actions</th></tr></thead>
            <tbody id="devTable"></tbody>
          </table>
          <div id="devEmpty" class="empty-state" style="display:none;"><div class="empty-icon">üñ•Ô∏è</div><div class="empty-text">No devices yet. Add your first device!</div></div>
        </div>
      </div>
    </div>

    <!-- REPORTS -->
    <div id="page-reports" class="page">
      <div class="page-header">
        <div class="page-title">Reports & Analytics</div>
        <div class="page-sub">PM performance overview</div>
        <div class="page-actions">
          <button class="btn btn-secondary" onclick="exportCSV('all')">‚Üì Export All Data</button>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-card c1"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="rCompleted">0</div><div class="stat-label">Completed PMs</div></div>
        <div class="stat-card c2"><div class="stat-icon">üîÑ</div><div class="stat-value" id="rPending">0</div><div class="stat-label">Pending PMs</div></div>
        <div class="stat-card c3"><div class="stat-icon">üñ•Ô∏è</div><div class="stat-value" id="rDesktops">0</div><div class="stat-label">Desktops</div></div>
        <div class="stat-card c4"><div class="stat-icon">üíª</div><div class="stat-value" id="rLaptops">0</div><div class="stat-label">Laptops</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Top Technicians</div></div>
          <div class="card-body" id="rTechList"></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">PM by Type</div></div>
          <div class="card-body" id="rTypeList"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Monthly Activity (Last 6 Months)</div></div>
        <div class="card-body" id="rMonthly"></div>
      </div>
    </div>

  </main>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<!-- MODAL: PM LOG -->
<div class="modal-overlay" id="logModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="logModalTitle">New PM Log</div>
      <button class="modal-close" onclick="closeModal('logModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Date *</label>
          <input type="date" id="lDate">
        </div>
        <div class="form-group">
          <label>Device *</label>
          <select id="lDevice"><option value="">-- Select Device --</option></select>
        </div>
        <div class="form-group">
          <label>PM Type *</label>
          <select id="lType">
            <option>Routine PM</option><option>Deep Clean</option><option>Hardware Check</option>
            <option>Software Update</option><option>Full PM</option>
          </select>
        </div>
        <div class="form-group">
          <label>Technician *</label>
          <input type="text" id="lTech" placeholder="Technician name">
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="lLocation"><option>Onsite</option><option>Offsite</option></select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="lStatus"><option>Completed</option><option>In Progress</option><option>Pending</option></select>
        </div>
        <div class="form-group">
          <label>Next PM Date</label>
          <input type="date" id="lNextPM">
        </div>
        <div class="form-group">
          <label>Duration (mins)</label>
          <input type="number" id="lDuration" placeholder="e.g. 45">
        </div>
        <div class="form-group span2">
          <label>Actions Performed</label>
          <div class="checkbox-row" id="actionsChecklist">
            <label class="checkbox-item"><input type="checkbox" value="Dust cleaning"> Dust cleaning</label>
            <label class="checkbox-item"><input type="checkbox" value="Thermal paste"> Thermal paste</label>
            <label class="checkbox-item"><input type="checkbox" value="OS update"> OS update</label>
            <label class="checkbox-item"><input type="checkbox" value="Antivirus scan"> Antivirus scan</label>
            <label class="checkbox-item"><input type="checkbox" value="Disk check"> Disk check</label>
            <label class="checkbox-item"><input type="checkbox" value="RAM check"> RAM check</label>
            <label class="checkbox-item"><input type="checkbox" value="Driver update"> Driver update</label>
            <label class="checkbox-item"><input type="checkbox" value="BIOS check"> BIOS check</label>
          </div>
        </div>
        <div class="form-group span2">
          <label>Findings / Remarks</label>
          <textarea id="lFindings" placeholder="Describe what was found or done..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('logModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveLog()">Save Log</button>
    </div>
  </div>
</div>


<!-- MODAL: ADD / EDIT USER (admin) -->
<div class="modal-overlay" id="userModal">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <div class="modal-title" id="userModalTitle">Add User</div>
      <button class="modal-close" onclick="closeModal('userModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group span2">
          <label>Full Name *</label>
          <input type="text" id="uName" placeholder="e.g. Juan Dela Cruz">
        </div>
        <div class="form-group span2">
          <label>Department *</label>
          <input type="text" id="uDept" placeholder="e.g. Finance, HR, IT">
        </div>
        <div class="form-group span2">
          <label>Email *</label>
          <input type="email" id="uEmail" placeholder="user@company.com">
        </div>
        <div class="form-group span2">
          <label>Status</label>
          <select id="uStatus"><option>Active</option><option>Inactive</option></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveUser()">Save User</button>
    </div>
  </div>
</div>

<!-- MODAL: SELF-REGISTRATION -->
<div class="modal-overlay" id="registerModal">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <div class="modal-title">üìù Register as User</div>
      <button class="modal-close" onclick="closeModal('registerModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text2);margin-bottom:18px;">Fill in your details to register. Your information will be submitted to the PM system admin.</p>
      <div class="form-grid">
        <div class="form-group span2">
          <label>Full Name *</label>
          <input type="text" id="regName" placeholder="Your full name">
        </div>
        <div class="form-group span2">
          <label>Department *</label>
          <input type="text" id="regDept" placeholder="Your department">
        </div>
        <div class="form-group span2">
          <label>Email *</label>
          <input type="email" id="regEmail" placeholder="Your email address">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('registerModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitRegistration()">Submit Registration</button>
    </div>
  </div>
</div>

<!-- MODAL: DEVICE -->
<div class="modal-overlay" id="deviceModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="devModalTitle">Add Device</div>
      <button class="modal-close" onclick="closeModal('deviceModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Device Name *</label>
          <input type="text" id="dName" placeholder="e.g. PC-ADMIN-01">
        </div>
        <div class="form-group">
          <label>Type *</label>
          <select id="dType"><option>Desktop</option><option>Laptop</option></select>
        </div>
        <div class="form-group">
          <label>Brand</label>
          <input type="text" id="dBrand" placeholder="e.g. Dell, HP, Lenovo">
        </div>
        <div class="form-group">
          <label>Model</label>
          <input type="text" id="dModel" placeholder="e.g. OptiPlex 7080">
        </div>
        <div class="form-group">
          <label>Serial Number</label>
          <input type="text" id="dSerial" placeholder="Serial number">
        </div>
        <div class="form-group">
          <label>Processor</label>
          <input type="text" id="dCPU" placeholder="e.g. Intel i5-10th Gen">
        </div>
        <div class="form-group">
          <label>RAM</label>
          <input type="text" id="dRAM" placeholder="e.g. 8GB DDR4">
        </div>
        <div class="form-group">
          <label>Storage</label>
          <input type="text" id="dStorage" placeholder="e.g. 256GB SSD">
        </div>
        <div class="form-group">
          <label>OS</label>
          <input type="text" id="dOS" placeholder="e.g. Windows 11 Pro">
        </div>
        <div class="form-group">
          <label>Location / Department</label>
          <input type="text" id="dLocation" placeholder="e.g. IT Dept, 2nd Floor">
        </div>
        <div class="form-group">
          <label>Assigned User</label>
          <input type="text" id="dUser" placeholder="User's name">
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="dStatus"><option>Active</option><option>Under Repair</option><option>Retired</option></select>
        </div>
        <div class="form-group">
          <label>Purchase Date</label>
          <input type="date" id="dPurchase">
        </div>
        <div class="form-group">
          <label>Warranty Expiry</label>
          <input type="date" id="dWarranty">
        </div>
        <div class="form-group span2">
          <label>Notes</label>
          <textarea id="dNotes" placeholder="Additional notes..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('deviceModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDevice()">Save Device</button>
    </div>
  </div>
</div>

<!-- MODAL: BUSINESS UNIT -->
<div class="modal-overlay" id="buModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="buModalTitle">Add Business Unit</div>
      <button class="modal-close" onclick="closeModal('buModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Business Unit Name *</label>
          <input type="text" id="buName" placeholder="e.g. Finance, HR, IT">
        </div>
        <div class="form-group">
          <label>PM Month *</label>
          <select id="buMonth">
            <option value="1">January</option><option value="2">February</option>
            <option value="3">March</option><option value="4">April</option>
            <option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option>
            <option value="9">September</option><option value="10">October</option>
            <option value="11">November</option><option value="12">December</option>
          </select>
        </div>
        <div class="form-group span2">
          <label>Location / Department</label>
          <input type="text" id="buLocation" placeholder="e.g. 2nd Floor, Main Building">
        </div>
        <div class="form-group span2">
          <label>Contact Person</label>
          <input type="text" id="buContact" placeholder="Name and/or contact number">
        </div>
        <div class="form-group span2">
          <label>Notes</label>
          <textarea id="buNotes" placeholder="Special instructions or notes..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('buModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveBU()">Save Business Unit</button>
    </div>
  </div>
</div>

<!-- MODAL: SCHEDULE -->
<div class="modal-overlay" id="scheduleModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Add Maintenance Schedule</div>
      <button class="modal-close" onclick="closeModal('scheduleModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Device *</label>
          <select id="sDevice"><option value="">-- Select Device --</option></select>
        </div>
        <div class="form-group">
          <label>Scheduled Date *</label>
          <input type="date" id="sDate">
        </div>
        <div class="form-group">
          <label>PM Type</label>
          <select id="sType"><option>Routine PM</option><option>Deep Clean</option><option>Hardware Check</option><option>Software Update</option><option>Full PM</option></select>
        </div>
        <div class="form-group">
          <label>Assigned To (Requestor)</label>
          <select id="sAssigned">
            <option value="">-- Select User --</option>
          </select>
        </div>
        <div class="form-group span2">
          <label>Notes</label>
          <textarea id="sNotes" placeholder="Special instructions..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('scheduleModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSchedule()">Save Schedule</button>
    </div>
  </div>
</div>

<!-- MODAL: GOOGLE SHEETS SETUP -->
<div class="modal-overlay" id="gsModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚ö° Google Sheets Integration Setup</div>
      <button class="modal-close" onclick="closeModal('gsModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text2);margin-bottom:18px;">Connect to Google Sheets so all PM data syncs automatically. Follow these steps:</p>

      <div class="gs-step-row">
        <div class="gs-step-num">1</div>
        <div class="gs-step-content">
          <div class="gs-step-title">Create a Google Sheet</div>
          <div class="gs-step-desc">Go to <strong>sheets.google.com</strong> and create a new spreadsheet. Name it "PM Tracker". Create 3 sheets (tabs): <strong>PM_Logs</strong>, <strong>Devices</strong>, <strong>Schedules</strong>.</div>
        </div>
      </div>

      <div class="gs-step-row">
        <div class="gs-step-num">2</div>
        <div class="gs-step-content">
          <div class="gs-step-title">Create an Apps Script Web App</div>
          <div class="gs-step-desc">In your Google Sheet, go to <strong>Extensions ‚Üí Apps Script</strong>. Delete the default code and paste the script below. Click <strong>Deploy ‚Üí New deployment ‚Üí Web app</strong>. Set "Who has access" to <strong>Anyone</strong>. Copy the Web App URL.</div>
          <div class="code-block" id="appsScriptCode">Loading script...</div>
          <button class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="copyScript()">üìã Copy Script</button>
        </div>
      </div>

      <div class="gs-step-row">
        <div class="gs-step-num">3</div>
        <div class="gs-step-content">
          <div class="gs-step-title">Paste Your Web App URL</div>
          <div class="gs-step-desc">After deploying, paste the Web App URL below.</div>
          <input type="text" id="gsURL" placeholder="https://script.google.com/macros/s/..." style="margin-top:8px;" value="">
        </div>
      </div>

      <div class="gs-step-row">
        <div class="gs-step-num">4</div>
        <div class="gs-step-content">
          <div class="gs-step-title">Test Connection</div>
          <div class="gs-step-desc">Click "Test & Save" to verify the connection.</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('gsModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGSConfig()">Test & Save Connection</button>
    </div>
  </div>
</div>

<script>
// ==================== DATA STORE ====================
let db = {
  devices: JSON.parse(localStorage.getItem('pm_devices') || '[]'),
  logs: JSON.parse(localStorage.getItem('pm_logs') || '[]'),
  schedules: JSON.parse(localStorage.getItem('pm_schedules') || '[]'),
  bus: JSON.parse(localStorage.getItem('pm_bus') || '[]'),
  users: JSON.parse(localStorage.getItem('pm_users') || '[]'),
  gsURL: localStorage.getItem('pm_gsURL') || '',
  gsConnected: localStorage.getItem('pm_gsConnected') === 'true'
};
let editingLog = null, editingDevice = null;

function save() {
  localStorage.setItem('pm_devices', JSON.stringify(db.devices));
  localStorage.setItem('pm_logs', JSON.stringify(db.logs));
  localStorage.setItem('pm_schedules', JSON.stringify(db.schedules));
  localStorage.setItem('pm_bus', JSON.stringify(db.bus));
  localStorage.setItem('pm_users', JSON.stringify(db.users));
}

// ==================== NAVIGATION ====================
function navigate(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelector(`[onclick="navigate('${page}')"]`).classList.add('active');
  if (page === 'dashboard') renderDashboard();
  if (page === 'log') renderLogs();
  if (page === 'inventory') renderDevices();
  if (page === 'bu') renderBU();
  if (page === 'users') renderUsers();
  if (page === 'schedule') renderSchedule();
  if (page === 'reports') renderReports();
}

// ==================== MODALS ====================
function openLogModal(id = null) {
  editingLog = id;
  const log = id ? db.logs.find(l => l.id == id) : null;
  document.getElementById('logModalTitle').textContent = id ? 'Edit PM Log' : 'New PM Log';
  document.getElementById('lDate').value = log ? log.date : new Date().toISOString().split('T')[0];
  document.getElementById('lTech').value = log ? log.tech : '';
  document.getElementById('lType').value = log ? log.type : 'Routine PM';
  document.getElementById('lLocation').value = log ? log.location : 'Onsite';
  document.getElementById('lStatus').value = log ? log.status : 'Completed';
  document.getElementById('lNextPM').value = log ? log.nextPM : '';
  document.getElementById('lDuration').value = log ? log.duration : '';
  document.getElementById('lFindings').value = log ? log.findings : '';
  // populate devices
  const sel = document.getElementById('lDevice');
  sel.innerHTML = '<option value="">-- Select Device --</option>' + db.devices.map(d => `<option value="${d.id}" ${log && log.deviceId == d.id ? 'selected' : ''}>${d.name}</option>`).join('');
  // checkboxes
  document.querySelectorAll('#actionsChecklist input[type=checkbox]').forEach(cb => {
    cb.checked = log ? (log.actions || []).includes(cb.value) : false;
  });
  openModal('logModal');
}

function openDeviceModal(id = null) {
  editingDevice = id;
  const d = id ? db.devices.find(x => x.id == id) : null;
  document.getElementById('devModalTitle').textContent = id ? 'Edit Device' : 'Add Device';
  ['Name','Brand','Model','Serial','CPU','RAM','Storage','OS','Location','User','Notes'].forEach(f => {
    document.getElementById('d' + f).value = d ? (d[f.toLowerCase()] || '') : '';
  });
  document.getElementById('dType').value = d ? d.type : 'Desktop';
  document.getElementById('dStatus').value = d ? d.status : 'Active';
  document.getElementById('dPurchase').value = d ? (d.purchase || '') : '';
  document.getElementById('dWarranty').value = d ? (d.warranty || '') : '';
  openModal('deviceModal');
}

function openScheduleModal() {
  const sel = document.getElementById('sDevice');
  sel.innerHTML = '<option value="">-- Select Device --</option>' + db.devices.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

  const userSel = document.getElementById('sAssigned');
  const activeUsers = db.users.filter(u => u.status === 'Active');
  if (activeUsers.length) {
    userSel.innerHTML = '<option value="">-- Select User --</option>' + activeUsers.map(u => `<option value="${u.id}">${u.name} ‚Äî ${u.dept}</option>`).join('');
  } else {
    userSel.innerHTML = '<option value="">No registered users yet</option>';
  }

  document.getElementById('sDate').value = '';
  document.getElementById('sNotes').value = '';
  openModal('scheduleModal');
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ==================== SAVE FUNCTIONS ====================
function saveLog() {
  const deviceId = document.getElementById('lDevice').value;
  const date = document.getElementById('lDate').value;
  const tech = document.getElementById('lTech').value.trim();
  if (!deviceId || !date || !tech) { toast('Please fill in required fields.', 'error'); return; }
  const device = db.devices.find(d => d.id == deviceId);
  const actions = [...document.querySelectorAll('#actionsChecklist input:checked')].map(c => c.value);
  const log = {
    id: editingLog || Date.now(),
    date, deviceId, deviceName: device ? device.name : '',
    type: document.getElementById('lType').value,
    tech, location: document.getElementById('lLocation').value,
    status: document.getElementById('lStatus').value,
    nextPM: document.getElementById('lNextPM').value,
    duration: document.getElementById('lDuration').value,
    actions, findings: document.getElementById('lFindings').value
  };
  if (editingLog) { const i = db.logs.findIndex(l => l.id == editingLog); db.logs[i] = log; }
  else db.logs.unshift(log);
  // Update device last PM
  if (device) { device.lastPM = date; save(); }
  save();
  closeModal('logModal');
  toast(editingLog ? 'Log updated!' : 'PM Log saved!', 'success');
  renderLogs(); renderDashboard();
  if (db.gsConnected) syncToSheets(true);
}

function saveDevice() {
  const name = document.getElementById('dName').value.trim();
  if (!name) { toast('Device name is required.', 'error'); return; }
  const device = {
    id: editingDevice || Date.now(),
    name, type: document.getElementById('dType').value,
    brand: document.getElementById('dBrand').value,
    model: document.getElementById('dModel').value,
    serial: document.getElementById('dSerial').value,
    cpu: document.getElementById('dCPU').value,
    ram: document.getElementById('dRAM').value,
    storage: document.getElementById('dStorage').value,
    os: document.getElementById('dOS').value,
    location: document.getElementById('dLocation').value,
    user: document.getElementById('dUser').value,
    status: document.getElementById('dStatus').value,
    purchase: document.getElementById('dPurchase').value,
    warranty: document.getElementById('dWarranty').value,
    notes: document.getElementById('dNotes').value,
    lastPM: editingDevice ? (db.devices.find(x=>x.id==editingDevice)||{}).lastPM : ''
  };
  if (editingDevice) { const i = db.devices.findIndex(d => d.id == editingDevice); db.devices[i] = device; }
  else db.devices.push(device);
  save();
  closeModal('deviceModal');
  toast(editingDevice ? 'Device updated!' : 'Device added!', 'success');
  renderDevices(); renderDashboard();
  if (db.gsConnected) syncToSheets(true);
}

function saveSchedule() {
  const deviceId = document.getElementById('sDevice').value;
  const date = document.getElementById('sDate').value;
  if (!deviceId || !date) { toast('Please select a device and date.', 'error'); return; }
  const device = db.devices.find(d => d.id == deviceId);
  const userId = document.getElementById('sAssigned').value;
  const assignedUser = db.users.find(u => u.id == userId);
  const sched = {
    id: Date.now(), deviceId, deviceName: device ? device.name : '',
    date, type: document.getElementById('sType').value,
    userId: userId || '',
    assigned: assignedUser ? assignedUser.name : '',
    assignedDept: assignedUser ? assignedUser.dept : '',
    notes: document.getElementById('sNotes').value,
    status: new Date(date) < new Date() ? 'Overdue' : 'Scheduled'
  };
  db.schedules.push(sched);
  save();
  closeModal('scheduleModal');
  toast('Schedule added!', 'success');
  renderSchedule(); renderDashboard();
}

function deleteLog(id) {
  if (!confirm('Delete this PM log?')) return;
  db.logs = db.logs.filter(l => l.id != id);
  save(); renderLogs(); renderDashboard();
  toast('Log deleted.', 'info');
}
function deleteDevice(id) {
  if (!confirm('Delete this device? All related logs will remain.')) return;
  db.devices = db.devices.filter(d => d.id != id);
  save(); renderDevices(); renderDashboard();
  toast('Device deleted.', 'info');
}
function deleteSchedule(id) {
  db.schedules = db.schedules.filter(s => s.id != id);
  save(); renderSchedule();
  toast('Schedule removed.', 'info');
}
function markDone(id) {
  const s = db.schedules.find(x => x.id == id);
  if (s) { s.status = 'Completed'; save(); renderSchedule(); toast('Marked as completed!', 'success'); }
}

// ==================== RENDER FUNCTIONS ====================
function statusBadge(status) {
  const map = { 'Completed': 'badge-green', 'In Progress': 'badge-blue', 'Pending': 'badge-orange', 'Overdue': 'badge-red', 'Active': 'badge-green', 'Under Repair': 'badge-orange', 'Retired': 'badge-gray', 'Scheduled': 'badge-blue' };
  return `<span class="badge ${map[status]||'badge-gray'}">${status}</span>`;
}

function renderDashboard() {
  document.getElementById('dashDate').textContent = new Date().toLocaleDateString('en-PH', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  document.getElementById('statDevices').textContent = db.devices.length;
  const now = new Date(), monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  document.getElementById('statLogs').textContent = db.logs.filter(l => new Date(l.date) >= monthStart).length;
  const weekEnd = new Date(now); weekEnd.setDate(weekEnd.getDate() + 7);
  const due = db.schedules.filter(s => { const d = new Date(s.date); return d >= now && d <= weekEnd && s.status !== 'Completed'; });
  document.getElementById('statDue').textContent = due.length;
  const overdue = db.schedules.filter(s => new Date(s.date) < now && s.status !== 'Completed');
  document.getElementById('statOverdue').textContent = overdue.length;

  const rl = document.getElementById('recentLogs');
  const recent = db.logs.slice(0, 5);
  if (!recent.length) { rl.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No logs yet</div></div>'; }
  else {
    rl.innerHTML = recent.map(l => `
      <div class="schedule-item">
        <div class="schedule-date">${l.date}</div>
        <div class="schedule-info"><div class="schedule-device">${l.deviceName}</div><div class="schedule-type">${l.type} ‚Äî ${l.tech}</div></div>
        ${statusBadge(l.status)}
      </div>`).join('');
  }
  const us = document.getElementById('upcomingSchedule');
  const upcoming = db.schedules.filter(s => new Date(s.date) >= now && s.status !== 'Completed').sort((a,b) => new Date(a.date)-new Date(b.date)).slice(0,5);
  if (!upcoming.length) { us.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><div class="empty-text">No upcoming schedule</div></div>'; }
  else {
    us.innerHTML = upcoming.map(s => `
      <div class="schedule-item">
        <div class="schedule-date">${s.date}</div>
        <div class="schedule-info"><div class="schedule-device">${s.deviceName}</div><div class="schedule-type">${s.type}</div></div>
        ${statusBadge(s.status)}
      </div>`).join('');
  }
}

function renderLogs() {
  const search = (document.getElementById('logSearch').value||'').toLowerCase();
  const fStatus = document.getElementById('logFilterStatus').value;
  const fType = document.getElementById('logFilterType').value;
  let logs = db.logs.filter(l => {
    if (search && !l.deviceName.toLowerCase().includes(search) && !l.tech.toLowerCase().includes(search)) return false;
    if (fStatus && l.status !== fStatus) return false;
    if (fType && l.type !== fType) return false;
    return true;
  });
  const tbody = document.getElementById('logTable');
  const empty = document.getElementById('logEmpty');
  if (!logs.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = logs.map((l,i) => `
    <tr>
      <td style="color:var(--text3);font-family:var(--mono);font-size:11px">${i+1}</td>
      <td style="font-family:var(--mono);font-size:12px">${l.date}</td>
      <td><strong>${l.deviceName}</strong></td>
      <td>${l.type}</td>
      <td>${l.tech}</td>
      <td><span class="badge ${l.location==='Onsite'?'badge-green':'badge-blue'}">${l.location}</span></td>
      <td>${statusBadge(l.status)}</td>
      <td style="font-family:var(--mono);font-size:12px;color:var(--text2)">${l.nextPM||'‚Äî'}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="openLogModal(${l.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteLog(${l.id})">Del</button>
      </td>
    </tr>`).join('');
}

function renderDevices() {
  const search = (document.getElementById('devSearch').value||'').toLowerCase();
  const fType = document.getElementById('devFilterType').value;
  const fStatus = document.getElementById('devFilterStatus').value;
  let devs = db.devices.filter(d => {
    if (search && !d.name.toLowerCase().includes(search) && !(d.serial||'').toLowerCase().includes(search) && !(d.user||'').toLowerCase().includes(search)) return false;
    if (fType && d.type !== fType) return false;
    if (fStatus && d.status !== fStatus) return false;
    return true;
  });
  const tbody = document.getElementById('devTable');
  const empty = document.getElementById('devEmpty');
  if (!devs.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = devs.map((d,i) => `
    <tr>
      <td style="color:var(--text3);font-family:var(--mono);font-size:11px">${i+1}</td>
      <td><strong>${d.name}</strong></td>
      <td><span class="badge ${d.type==='Laptop'?'badge-blue':'badge-gray'}">${d.type==='Laptop'?'üíª':'üñ•Ô∏è'} ${d.type}</span></td>
      <td>${d.brand||''} ${d.model||''}</td>
      <td style="font-family:var(--mono);font-size:12px">${d.serial||'‚Äî'}</td>
      <td>${d.location||'‚Äî'}</td>
      <td>${d.user||'‚Äî'}</td>
      <td>${statusBadge(d.status)}</td>
      <td style="font-family:var(--mono);font-size:12px;color:var(--text2)">${d.lastPM||'‚Äî'}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="openDeviceModal(${d.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteDevice(${d.id})">Del</button>
      </td>
    </tr>`).join('');
}

function renderSchedule() {
  const now = new Date();
  const upcoming = db.schedules.filter(s => new Date(s.date) >= now && s.status !== 'Completed').sort((a,b) => new Date(a.date)-new Date(b.date));
  const overdue = db.schedules.filter(s => new Date(s.date) < now && s.status !== 'Completed');

  document.getElementById('overdueBanner').style.display = overdue.length ? 'flex' : 'none';
  if (overdue.length) document.getElementById('overdueCount').textContent = overdue.length;

  const su = document.getElementById('schedUpcoming');
  if (!upcoming.length) su.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">All clear!</div></div>';
  else su.innerHTML = upcoming.slice(0,5).map(s => `
    <div class="schedule-item">
      <div class="schedule-date">${s.date}</div>
      <div class="schedule-info">
        <div class="schedule-device">${s.deviceName}</div>
        <div class="schedule-type">${s.buName ? s.buName + ' ¬∑ ' : ''}${s.type}${s.assigned?' ‚Äî '+s.assigned:''}</div>
      </div>
      ${statusBadge('Scheduled')}
    </div>`).join('');

  const so = document.getElementById('schedOverdue');
  if (!overdue.length) so.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">No overdue!</div></div>';
  else so.innerHTML = overdue.map(s => `
    <div class="schedule-item">
      <div class="schedule-date" style="color:var(--danger)">${s.date}</div>
      <div class="schedule-info">
        <div class="schedule-device">${s.deviceName}</div>
        <div class="schedule-type">${s.buName ? s.buName + ' ¬∑ ' : ''}${s.type}</div>
      </div>
      ${statusBadge('Overdue')}
    </div>`).join('');

  const tbody = document.getElementById('schedTable');
  const empty = document.getElementById('schedEmpty');
  if (!db.schedules.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = db.schedules.map(s => `
    <tr>
      <td><strong>${s.deviceName}</strong></td>
      <td style="font-size:12px;color:var(--text2)">${s.buName||'‚Äî'}</td>
      <td style="font-family:var(--mono);font-size:12px">${s.date}</td>
      <td>${s.type}</td>
      <td>${s.assigned||'‚Äî'}</td>
      <td>${statusBadge(s.status)}</td>
      <td style="color:var(--text2);font-size:12px">${s.notes||'‚Äî'}</td>
      <td>
        ${s.status!=='Completed'?`<button class="btn btn-sm btn-primary" onclick="markDone(${s.id})">Done</button>`:''}
        <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${s.id})">Del</button>
      </td>
    </tr>`).join('');
}

function renderReports() {
  const completed = db.logs.filter(l => l.status === 'Completed').length;
  const pending = db.logs.filter(l => l.status !== 'Completed').length;
  document.getElementById('rCompleted').textContent = completed;
  document.getElementById('rPending').textContent = pending;
  document.getElementById('rDesktops').textContent = db.devices.filter(d => d.type==='Desktop').length;
  document.getElementById('rLaptops').textContent = db.devices.filter(d => d.type==='Laptop').length;

  // Top Techs
  const techs = {};
  db.logs.forEach(l => { techs[l.tech] = (techs[l.tech]||0) + 1; });
  const techEl = document.getElementById('rTechList');
  const sorted = Object.entries(techs).sort((a,b) => b[1]-a[1]).slice(0,5);
  if (!sorted.length) { techEl.innerHTML = '<div class="empty-state" style="padding:20px"><div class="empty-text">No data yet</div></div>'; }
  else {
    const max = sorted[0][1];
    techEl.innerHTML = sorted.map(([name, count]) => `
      <div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <span style="font-size:13px">${name}</span>
          <span style="font-family:var(--mono);font-size:12px;color:var(--accent)">${count} PMs</span>
        </div>
        <div style="background:var(--surface2);border-radius:4px;height:6px">
          <div style="background:var(--accent);width:${(count/max*100)}%;height:100%;border-radius:4px"></div>
        </div>
      </div>`).join('');
  }

  // PM Types
  const types = {};
  db.logs.forEach(l => { types[l.type] = (types[l.type]||0) + 1; });
  const typeEl = document.getElementById('rTypeList');
  const sortedT = Object.entries(types).sort((a,b) => b[1]-a[1]);
  if (!sortedT.length) { typeEl.innerHTML = '<div class="empty-state" style="padding:20px"><div class="empty-text">No data yet</div></div>'; }
  else {
    const maxT = sortedT[0][1];
    typeEl.innerHTML = sortedT.map(([name, count]) => `
      <div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <span style="font-size:13px">${name}</span>
          <span style="font-family:var(--mono);font-size:12px;color:var(--accent2)">${count}</span>
        </div>
        <div style="background:var(--surface2);border-radius:4px;height:6px">
          <div style="background:var(--accent2);width:${(count/maxT*100)}%;height:100%;border-radius:4px"></div>
        </div>
      </div>`).join('');
  }

  // Monthly
  const monthly = {};
  const months = [];
  for (let i = 5; i >= 0; i--) {
    const d = new Date(); d.setMonth(d.getMonth() - i);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const label = d.toLocaleDateString('en', {month:'short', year:'2-digit'});
    monthly[key] = 0; months.push({key, label});
  }
  db.logs.forEach(l => { const k = l.date.slice(0,7); if (monthly[k] !== undefined) monthly[k]++; });
  const maxM = Math.max(...Object.values(monthly), 1);
  document.getElementById('rMonthly').innerHTML = `
    <div style="display:flex;align-items:flex-end;gap:10px;height:100px;padding-bottom:4px">
      ${months.map(m => `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
          <span style="font-family:var(--mono);font-size:11px;color:var(--accent)">${monthly[m.key]||0}</span>
          <div style="width:100%;background:var(--surface2);border-radius:4px 4px 0 0;height:${Math.max((monthly[m.key]/maxM)*80,4)}px;background:var(--accent3)"></div>
          <span style="font-size:11px;color:var(--text2)">${m.label}</span>
        </div>`).join('')}
    </div>`;
}

// ==================== BUSINESS UNITS ====================
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
let buMonthFilter = null;
let editingBU = null;

function openBUModal(id = null) {
  editingBU = id;
  const bu = id ? db.bus.find(b => b.id == id) : null;
  document.getElementById('buModalTitle').textContent = id ? 'Edit Business Unit' : 'Add Business Unit';
  document.getElementById('buName').value = bu ? bu.name : '';
  document.getElementById('buMonth').value = bu ? bu.month : (new Date().getMonth() + 1);
  document.getElementById('buLocation').value = bu ? (bu.location || '') : '';
  document.getElementById('buContact').value = bu ? (bu.contact || '') : '';
  document.getElementById('buNotes').value = bu ? (bu.notes || '') : '';
  openModal('buModal');
}

function saveBU() {
  const name = document.getElementById('buName').value.trim();
  const month = parseInt(document.getElementById('buMonth').value);
  if (!name) { toast('Business Unit name is required.', 'error'); return; }

  // Check if another BU already has this month (excluding current edit)
  const conflict = db.bus.find(b => b.month === month && b.id != editingBU);
  if (conflict) {
    toast(`${MONTHS[month-1]} is already assigned to "${conflict.name}".`, 'error');
    return;
  }

  const existing = editingBU ? db.bus.find(b => b.id == editingBU) : null;
  const bu = {
    id: editingBU || Date.now(),
    name, month,
    location: document.getElementById('buLocation').value,
    contact: document.getElementById('buContact').value,
    notes: document.getElementById('buNotes').value,
    deviceIds: existing ? (existing.deviceIds || []) : []
  };

  if (editingBU) {
    const i = db.bus.findIndex(b => b.id == editingBU);
    db.bus[i] = bu;
  } else {
    db.bus.push(bu);
  }
  save();
  closeModal('buModal');
  toast(editingBU ? 'Business Unit updated!' : 'Business Unit saved!', 'success');
  renderBU();
  if (db.gsConnected) syncToSheets(true);
}

function autoGenerateSchedules(bu) {
  const year = new Date().getFullYear();
  const monthStr = String(bu.month).padStart(2, '0');
  // Use 1st of the BU's month as the scheduled date
  const schedDate = `${year}-${monthStr}-01`;

  bu.deviceIds.forEach(devId => {
    const device = db.devices.find(d => d.id == devId);
    if (!device) return;

    // Check if a schedule for this device + BU month already exists this year
    const exists = db.schedules.find(s =>
      s.deviceId == devId &&
      s.buId == bu.id &&
      s.date.startsWith(year + '-' + monthStr)
    );
    if (exists) return;

    const now = new Date();
    const schedDateObj = new Date(schedDate);
    db.schedules.push({
      id: Date.now() + Math.random(),
      deviceId: devId,
      deviceName: device.name,
      buId: bu.id,
      buName: bu.name,
      date: schedDate,
      type: 'Routine PM',
      assigned: bu.tech || '',
      notes: `Auto-generated for ${bu.name} ‚Äî ${MONTHS[bu.month-1]} PM`,
      status: schedDateObj < now ? 'Overdue' : 'Scheduled'
    });
  });
  save();
}

function deleteBU(id) {
  if (!confirm('Delete this Business Unit? Auto-generated schedules from this BU will also be removed.')) return;
  // Remove BU-linked schedules
  db.schedules = db.schedules.filter(s => s.buId != id);
  db.bus = db.bus.filter(b => b.id != id);
  save();
  renderBU();
  toast('Business Unit deleted.', 'info');
}

function clearBUMonthFilter() {
  buMonthFilter = null;
  document.getElementById('buClearFilter').style.display = 'none';
  document.getElementById('buListTitle').textContent = 'All Business Units';
  renderBUList();
  // Reset month grid highlight
  document.querySelectorAll('.month-card').forEach(c => c.style.outline = '');
}

function filterByMonth(monthNum) {
  buMonthFilter = monthNum;
  document.getElementById('buClearFilter').style.display = 'inline-flex';
  document.getElementById('buListTitle').textContent = `Business Units ‚Äî ${MONTHS[monthNum-1]}`;
  renderBUList();
}

function renderBU() {
  renderBUMonthGrid();
  renderBUList();
}

function renderBUMonthGrid() {
  const currentMonth = new Date().getMonth() + 1;
  const grid = document.getElementById('buMonthGrid');
  grid.innerHTML = MONTHS.map((m, i) => {
    const monthNum = i + 1;
    const bu = db.bus.find(b => b.month === monthNum);
    const isCurrent = monthNum === currentMonth;
    const completedCount = bu ? db.schedules.filter(s => s.buId == bu.id && s.status === 'Completed').length : 0;
    const totalCount = bu ? (bu.deviceIds || []).length : 0;
    return `
      <div class="month-card ${isCurrent ? 'current-month' : ''} ${bu ? 'has-bu' : ''}"
           onclick="filterByMonth(${monthNum})" title="Click to filter">
        <div class="month-card-label">${isCurrent ? '‚ñ∂ This month' : 'Month ' + monthNum}</div>
        <div class="month-card-name">${m}</div>
        ${bu ? `
          <div class="month-card-bu">üè¢ ${bu.name}</div>
          ${totalCount > 0 ? `
            <div class="progress-bar-wrap" style="margin-top:6px;">
              <div class="progress-bar-fill" style="width:${Math.round(completedCount/totalCount*100)}%"></div>
            </div>
            <div style="font-size:10px;color:var(--text3);margin-top:3px;">${completedCount}/${totalCount} done</div>
          ` : ''}
          <div class="month-card-badge">${isCurrent ? '<span class="badge badge-green" style="font-size:10px;">Active</span>' : ''}</div>
        ` : `<div style="font-size:11px;color:var(--text3);margin-top:6px;">No BU assigned</div>`}
      </div>`;
  }).join('');
}

function renderBUList() {
  const container = document.getElementById('buList');
  let list = buMonthFilter ? db.bus.filter(b => b.month === buMonthFilter) : db.bus;
  list = list.slice().sort((a, b) => a.month - b.month);

  if (!list.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üè¢</div><div class="empty-text">' +
      (buMonthFilter ? 'No BU assigned to ' + MONTHS[buMonthFilter-1] : 'No Business Units yet. Add your first BU!') +
      '</div></div>';
    return;
  }

  const currentMonth = new Date().getMonth() + 1;
  container.innerHTML = list.map(bu => {
    const devices = db.devices.filter(d => (bu.deviceIds || []).includes(d.id));
    const schedules = db.schedules.filter(s => s.buId == bu.id);
    const completed = schedules.filter(s => s.status === 'Completed').length;
    const isActive = bu.month === currentMonth;

    return `
      <div class="bu-card">
        <div class="bu-card-header">
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="month-pill ${isActive ? 'active-month' : ''}">${MONTHS[bu.month-1]}</span>
            <div class="bu-card-name">üè¢ ${bu.name}</div>
            ${isActive ? '<span class="badge badge-green" style="font-size:10px;">This Month</span>' : ''}
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-sm btn-secondary" onclick="openBUModal(${bu.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteBU(${bu.id})">Delete</button>
          </div>
        </div>
        <div class="bu-card-meta">
          ${bu.location ? `<span>üìç ${bu.location}</span>` : ''}
          ${bu.tech ? `<span>üîß ${bu.tech}</span>` : ''}
          ${bu.contact ? `<span>üë§ ${bu.contact}</span>` : ''}
          <span>üñ•Ô∏è ${devices.length} device${devices.length !== 1 ? 's' : ''}</span>
          <span>üìã ${completed}/${schedules.length} PM done</span>
        </div>
        ${schedules.length > 0 ? `
          <div class="progress-bar-wrap">
            <div class="progress-bar-fill" style="width:${schedules.length > 0 ? Math.round(completed/schedules.length*100) : 0}%"></div>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;margin-bottom:8px;">${schedules.length > 0 ? Math.round(completed/schedules.length*100) : 0}% complete</div>
        ` : ''}
        ${bu.notes ? `<div style="font-size:12px;color:var(--text2);margin-bottom:8px;">üìù ${bu.notes}</div>` : ''}
        <div class="bu-devices">
          ${devices.length ? devices.map(d => `<span class="bu-device-tag">${d.type === 'Laptop' ? 'üíª' : 'üñ•Ô∏è'} ${d.name}</span>`).join('') : '<span style="font-size:12px;color:var(--text3);">No devices assigned yet</span>'}
        </div>
      </div>`;
  }).join('');
}

// ==================== USERS ====================
let editingUser = null;

function openUserModal(id = null) {
  editingUser = id;
  const u = id ? db.users.find(x => x.id == id) : null;
  document.getElementById('userModalTitle').textContent = id ? 'Edit User' : 'Add User';
  document.getElementById('uName').value = u ? u.name : '';
  document.getElementById('uDept').value = u ? u.dept : '';
  document.getElementById('uEmail').value = u ? u.email : '';
  document.getElementById('uStatus').value = u ? u.status : 'Active';
  openModal('userModal');
}

function saveUser() {
  const name = document.getElementById('uName').value.trim();
  const dept = document.getElementById('uDept').value.trim();
  const email = document.getElementById('uEmail').value.trim();
  if (!name || !dept || !email) { toast('Please fill in all required fields.', 'error'); return; }

  // Check duplicate email
  const duplicate = db.users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.id != editingUser);
  if (duplicate) { toast('A user with this email already exists.', 'error'); return; }

  const user = {
    id: editingUser || Date.now(),
    name, dept, email,
    status: document.getElementById('uStatus').value,
    registered: editingUser ? (db.users.find(u => u.id == editingUser)||{}).registered : new Date().toISOString().split('T')[0]
  };

  if (editingUser) {
    const i = db.users.findIndex(u => u.id == editingUser);
    db.users[i] = user;
  } else {
    db.users.push(user);
  }
  save();
  closeModal('userModal');
  toast(editingUser ? 'User updated!' : 'User added!', 'success');
  renderUsers();
  if (db.gsConnected) syncToSheets(true);
}

function deleteUser(id) {
  if (!confirm('Remove this user from the system?')) return;
  db.users = db.users.filter(u => u.id != id);
  save();
  renderUsers();
  toast('User removed.', 'info');
}

function submitRegistration() {
  const name = document.getElementById('regName').value.trim();
  const dept = document.getElementById('regDept').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  if (!name || !dept || !email) { toast('Please fill in all fields.', 'error'); return; }

  const duplicate = db.users.find(u => u.email.toLowerCase() === email.toLowerCase());
  if (duplicate) { toast('This email is already registered.', 'error'); return; }

  const user = {
    id: Date.now(),
    name, dept, email,
    status: 'Active',
    registered: new Date().toISOString().split('T')[0]
  };
  db.users.push(user);
  save();
  closeModal('registerModal');
  document.getElementById('regName').value = '';
  document.getElementById('regDept').value = '';
  document.getElementById('regEmail').value = '';
  toast(`Welcome, ${name}! Registration submitted successfully.`, 'success');
  if (db.gsConnected) syncToSheets(true);
}

function copyRegLink() {
  // The "link" is just the current file path ‚Äî in a hosted scenario this would be a URL.
  // We open the register modal as the self-serve flow instead.
  openModal('registerModal');
}

function renderUsers() {
  const search = (document.getElementById('userSearch')?.value || '').toLowerCase();
  const fDept = document.getElementById('userFilterDept')?.value || '';
  const fStatus = document.getElementById('userFilterStatus')?.value || '';

  // Populate dept filter
  const depts = [...new Set(db.users.map(u => u.dept).filter(Boolean))].sort();
  const deptSel = document.getElementById('userFilterDept');
  if (deptSel) {
    const current = deptSel.value;
    deptSel.innerHTML = '<option value="">All Departments</option>' + depts.map(d => `<option ${d===current?'selected':''}>${d}</option>`).join('');
  }

  let users = db.users.filter(u => {
    if (search && !u.name.toLowerCase().includes(search) && !u.email.toLowerCase().includes(search) && !u.dept.toLowerCase().includes(search)) return false;
    if (fDept && u.dept !== fDept) return false;
    if (fStatus && u.status !== fStatus) return false;
    return true;
  });

  const tbody = document.getElementById('userTable');
  const empty = document.getElementById('userEmpty');
  if (!users.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = users.map((u, i) => `
    <tr>
      <td style="color:var(--text3);font-family:var(--mono);font-size:11px">${i + 1}</td>
      <td><strong>${u.name}</strong></td>
      <td>${u.dept}</td>
      <td style="font-size:12px;color:var(--text2)">${u.email}</td>
      <td style="font-family:var(--mono);font-size:12px;color:var(--text2)">${u.registered || '‚Äî'}</td>
      <td>${statusBadge(u.status)}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="openUserModal(${u.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Remove</button>
      </td>
    </tr>`).join('');
}

// ==================== GOOGLE SHEETS ====================
const appsScript = `function doPost(e) {
  var data = JSON.parse(e.postData.contents);
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(data.sheet);

  if (!sheet) {
    sheet = ss.insertSheet(data.sheet);
  }

  if (data.action === 'clear_and_write') {
    sheet.clearContents();

    if (data.headers) {
      sheet.appendRow(data.headers);
    }

    (data.rows || []).forEach(function(row) {
      sheet.appendRow(row);
    });
  }

  return ContentService
    .createTextOutput(JSON.stringify({ status: 'ok' }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({ status: 'ready' }))
    .setMimeType(ContentService.MimeType.JSON);
}`;

document.getElementById('appsScriptCode').textContent = appsScript;

function copyScript() {
  navigator.clipboard.writeText(appsScript).then(() => toast('Script copied to clipboard!', 'success'));
}

function openGSModal() {
  document.getElementById('gsURL').value = db.gsURL || '';
  openModal('gsModal');
}

async function saveGSConfig() {
  const url = document.getElementById('gsURL').value.trim();
  if (!url) { toast('Please enter a Web App URL.', 'error'); return; }
  if (!url.startsWith('https://script.google.com/macros/s/')) {
    toast('URL must start with https://script.google.com/macros/s/...', 'error');
    return;
  }
  toast('Saving connection...', 'info');
  try {
    // CORS blocks reading the response, but a real network error still throws.
    // As long as the fetch doesn't throw, the URL domain is valid.
    await fetch(url, { method: 'GET', mode: 'no-cors' });
  } catch (err) {
    toast('Network error. Make sure you are online.', 'error');
    return;
  }
  db.gsURL = url;
  db.gsConnected = true;
  localStorage.setItem('pm_gsURL', url);
  localStorage.setItem('pm_gsConnected', 'true');
  updateGSStatus(true);
  closeModal('gsModal');
  toast('Google Sheets connected! ‚úÖ', 'success');
}

function updateGSStatus(connected) {
  document.getElementById('gsDot').className = 'gs-status-dot ' + (connected ? 'connected' : 'disconnected');
  document.getElementById('gsStatusText').textContent = connected ? 'Sheets connected' : 'Not connected';
}

async function syncToSheets(silent = false) {
  if (!db.gsConnected || !db.gsURL) {
    if (!silent) { toast('Connect to Google Sheets first!', 'error'); openGSModal(); }
    return;
  }
  if (!silent) { document.getElementById('syncIcon').innerHTML = '<span class="spinner"></span>'; }
  try {
    const sends = [
      { sheet: 'PM_Logs', headers: ['ID','Date','Device','PM Type','Technician','Location','Status','Next PM','Duration (min)','Actions','Findings'], rows: db.logs.map(l => [l.id, l.date, l.deviceName, l.type, l.tech, l.location, l.status, l.nextPM||'', l.duration||'', (l.actions||[]).join('; '), l.findings||'']) },
      { sheet: 'Devices', headers: ['ID','Name','Type','Brand','Model','Serial','CPU','RAM','Storage','OS','Location','User','Status','Last PM','Purchase','Warranty'], rows: db.devices.map(d => [d.id, d.name, d.type, d.brand||'', d.model||'', d.serial||'', d.cpu||'', d.ram||'', d.storage||'', d.os||'', d.location||'', d.user||'', d.status, d.lastPM||'', d.purchase||'', d.warranty||'']) },
      { sheet: 'Users', headers: ['ID','Full Name','Department','Email','Status','Registered'], rows: db.users.map(u => [u.id, u.name, u.dept, u.email, u.status, u.registered||'']) },
      { sheet: 'Business_Units', headers: ['ID','BU Name','PM Month','Location','Technician','Contact','Device Count','Notes'], rows: db.bus.map(b => [b.id, b.name, MONTHS[b.month-1], b.location||'', b.tech||'', b.contact||'', (b.deviceIds||[]).length, b.notes||'']) },
      { sheet: 'Schedules', headers: ['ID','Device','Business Unit','Date','Type','Assigned','Status','Notes'], rows: db.schedules.map(s => [s.id, s.deviceName, s.buName||'', s.date, s.type, s.assigned||'', s.status, s.notes||'']) }
    ];
    for (const payload of sends) {
      await fetch(db.gsURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'clear_and_write', ...payload }) });
    }
    if (!silent) { document.getElementById('syncIcon').textContent = '‚Üë'; toast('Synced to Google Sheets! ‚úÖ', 'success'); }
  } catch (err) {
    if (!silent) { document.getElementById('syncIcon').textContent = '‚Üë'; toast('Sync failed. Check connection.', 'error'); }
  }
}

// ==================== EXPORT CSV ====================
function exportCSV(type) {
  let rows = [], filename = '';
  if (type === 'logs' || type === 'all') {
    rows = [['Date','Device','PM Type','Technician','Location','Status','Next PM','Duration','Actions','Findings'], ...db.logs.map(l => [l.date, l.deviceName, l.type, l.tech, l.location, l.status, l.nextPM||'', l.duration||'', (l.actions||[]).join('; '), l.findings||''])];
    filename = 'PM_Logs.csv';
  }
  if (type === 'users') {
    rows = [['Full Name','Department','Email','Status','Registered'], ...db.users.map(u => [u.name, u.dept, u.email, u.status, u.registered||''])];
    filename = 'Users.csv';
  }
  if (type === 'devices') {
    rows = [['Name','Type','Brand','Model','Serial','CPU','RAM','Storage','OS','Location','User','Status','Last PM'], ...db.devices.map(d => [d.name, d.type, d.brand||'', d.model||'', d.serial||'', d.cpu||'', d.ram||'', d.storage||'', d.os||'', d.location||'', d.user||'', d.status, d.lastPM||''])];
    filename = 'Devices.csv';
  }
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = filename;
  a.click();
  toast('CSV exported!', 'success');
}

// ==================== TOAST ====================
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
  el.innerHTML = `<span>${icons[type]||''}</span><span>${msg}</span>`;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// ==================== INIT ====================
updateGSStatus(db.gsConnected);
renderDashboard();
document.getElementById('dashDate').textContent = new Date().toLocaleDateString('en-PH', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
</script>
</body>
</html>
